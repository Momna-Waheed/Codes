#include "PPGFilter.h"

#ifdef MAX30100
static int filter_taps[PPGFILTER_TAP_NUM] = {
  209,
  103,
  119,
  130,
  134,
  128,
  111,
  80,
  36,
  -22,
  -93,
  -175,
  -265,
  -360,
  -454,
  -542,
  -620,
  -679,
  -716,
  -723,
  -697,
  -635,
  -533,
  -391,
  -210,
  6,
  253,
  524,
  812,
  1108,
  1401,
  1682,
  1940,
  2167,
  2352,
  2490,
  2575,
  2604,
  2575,
  2490,
  2352,
  2167,
  1940,
  1682,
  1401,
  1108,
  812,
  524,
  253,
  6,
  -210,
  -391,
  -533,
  -635,
  -697,
  -723,
  -716,
  -679,
  -620,
  -542,
  -454,
  -360,
  -265,
  -175,
  -93,
  -22,
  36,
  80,
  111,
  128,
  134,
  130,
  119,
  103,
  209
};

#endif

#ifdef MAX30102
static int filter_taps[PPGFILTER_TAP_NUM] = {
    225,
    142,
    180,
    217,
    252,
    282,
    305,
    320,
    324,
    316,
    295,
    263,
    219,
    164,
    103,
    36,
    -32,
    -98,
    -159,
    -212,
    -253,
    -281,
    -294,
    -293,
    -277,
    -248,
    -210,
    -164,
    -115,
    -67,
    -23,
    13,
    38,
    50,
    47,
    31,
    1,
    -41,
    -90,
    -145,
    -200,
    -251,
    -295,
    -329,
    -349,
    -353,
    -343,
    -318,
    -280,
    -232,
    -179,
    -124,
    -73,
    -29,
    3,
    20,
    20,
    2,
    -33,
    -84,
    -148,
    -219,
    -293,
    -364,
    -428,
    -478,
    -511,
    -524,
    -514,
    -482,
    -429,
    -360,
    -278,
    -190,
    -102,
    -23,
    42,
    87,
    105,
    95,
    53,
    -18,
    -116,
    -236,
    -371,
    -511,
    -647,
    -768,
    -864,
    -925,
    -942,
    -909,
    -821,
    -678,
    -481,
    -233,
    57,
    380,
    723,
    1073,
    1415,
    1736,
    2020,
    2256,
    2432,
    2542,
    2579,
    2542,
    2432,
    2256,
    2020,
    1736,
    1415,
    1073,
    723,
    380,
    57,
    -233,
    -481,
    -678,
    -821,
    -909,
    -942,
    -925,
    -864,
    -768,
    -647,
    -511,
    -371,
    -236,
    -116,
    -18,
    53,
    95,
    105,
    87,
    42,
    -23,
    -102,
    -190,
    -278,
    -360,
    -429,
    -482,
    -514,
    -524,
    -511,
    -478,
    -428,
    -364,
    -293,
    -219,
    -148,
    -84,
    -33,
    2,
    20,
    20,
    3,
    -29,
    -73,
    -124,
    -179,
    -232,
    -280,
    -318,
    -343,
    -353,
    -349,
    -329,
    -295,
    -251,
    -200,
    -145,
    -90,
    -41,
    1,
    31,
    47,
    50,
    38,
    13,
    -23,
    -67,
    -115,
    -164,
    -210,
    -248,
    -277,
    -293,
    -294,
    -281,
    -253,
    -212,
    -159,
    -98,
    -32,
    36,
    103,
    164,
    219,
    263,
    295,
    316,
    324,
    320,
    305,
    282,
    252,
    217,
    180,
    142,
    225};

#endif

void PPGFilter_init(PPGFilter *f)
{
    int i;
    for (i = 0; i < PPGFILTER_TAP_NUM; ++i)
        f->history[i] = 0;
    f->last_index = 0;
}

void PPGFilter_put(PPGFilter *f, int input)
{
    f->history[f->last_index++] = input;
    if (f->last_index == PPGFILTER_TAP_NUM)
        f->last_index = 0;
}

int PPGFilter_get(PPGFilter *f)
{
    long long acc = 0;
    int index = f->last_index, i;
    for (i = 0; i < PPGFILTER_TAP_NUM; ++i)
    {
        index = index != 0 ? index - 1 : PPGFILTER_TAP_NUM - 1;
        acc += (long long)f->history[index] * filter_taps[i];
    };
    return acc >> 16;
}